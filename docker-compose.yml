# ============================================
# Docker Compose - Entorno Completo de Desarrollo
# ============================================
# 
# Uso:
#   docker-compose up              # Iniciar todo
#   docker-compose up -d           # Iniciar en background
#   docker-compose restart         # Reiniciar todo
#   docker-compose restart backend # Reiniciar solo backend
#   docker-compose down            # Parar todo
#   docker-compose up --build      # Rebuild y reiniciar
#
# ============================================

services:
  # ==========================================
  # MongoDB - Base de datos
  # ==========================================
  mongodb:
    image: mongo:7
    container_name: jlcava-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=jlcavaai
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # Backend Python (FastAPI)
  # ==========================================
  backend:
    build:
      context: ./data-engine
      dockerfile: Dockerfile
    container_name: jlcava-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      # Montar código para hot-reload en desarrollo
      - ./data-engine:/app
      # Excluir __pycache__ y .venv
      - /app/__pycache__
      - /app/.venv
    environment:
      - FMP_API_KEY=${FMP_API_KEY}
      - PYTHONUNBUFFERED=1
    depends_on:
      mongodb:
        condition: service_healthy

  # ==========================================
  # Frontend Next.js
  # ==========================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: jlcava-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      # Montar código para hot-reload en desarrollo
      - .:/app
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=development
      - MONGODB_URI=mongodb://mongodb:27017/jlcavaai
      - FMP_BACKEND_URL=http://backend:8000
      - FINNHUB_API_KEY=${FINNHUB_API_KEY}
      - FMP_API_KEY=${FMP_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - NEXT_PUBLIC_APP_URL=http://localhost:3000
    depends_on:
      - mongodb
      - backend

# ==========================================
# Volúmenes persistentes
# ==========================================
volumes:
  mongodb_data:
    name: jlcava-mongodb-data
